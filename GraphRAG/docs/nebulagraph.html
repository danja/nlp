<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<!--
generated by Pygments <https://pygments.org/>
Copyright 2006-2022 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
-->
<html>
<head>
  <title></title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <style type="text/css">
/*
generated by Pygments <https://pygments.org/>
Copyright 2006-2022 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
*/
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
body .hll { background-color: #ffffcc }
body { background: #f8f8f8; }
body .c { color: #3D7B7B; font-style: italic } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #008000; font-weight: bold } /* Keyword */
body .o { color: #666666 } /* Operator */
body .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
body .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
body .cp { color: #9C6500 } /* Comment.Preproc */
body .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
body .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
body .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .gr { color: #E40000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #008400 } /* Generic.Inserted */
body .go { color: #717171 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #0044DD } /* Generic.Traceback */
body .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
body .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #008000 } /* Keyword.Pseudo */
body .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666666 } /* Literal.Number */
body .s { color: #BA2121 } /* Literal.String */
body .na { color: #687822 } /* Name.Attribute */
body .nb { color: #008000 } /* Name.Builtin */
body .nc { color: #0000FF; font-weight: bold } /* Name.Class */
body .no { color: #880000 } /* Name.Constant */
body .nd { color: #AA22FF } /* Name.Decorator */
body .ni { color: #717171; font-weight: bold } /* Name.Entity */
body .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
body .nf { color: #0000FF } /* Name.Function */
body .nl { color: #767600 } /* Name.Label */
body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
body .nt { color: #008000; font-weight: bold } /* Name.Tag */
body .nv { color: #19177C } /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mb { color: #666666 } /* Literal.Number.Bin */
body .mf { color: #666666 } /* Literal.Number.Float */
body .mh { color: #666666 } /* Literal.Number.Hex */
body .mi { color: #666666 } /* Literal.Number.Integer */
body .mo { color: #666666 } /* Literal.Number.Oct */
body .sa { color: #BA2121 } /* Literal.String.Affix */
body .sb { color: #BA2121 } /* Literal.String.Backtick */
body .sc { color: #BA2121 } /* Literal.String.Char */
body .dl { color: #BA2121 } /* Literal.String.Delimiter */
body .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #BA2121 } /* Literal.String.Double */
body .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #BA2121 } /* Literal.String.Heredoc */
body .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #008000 } /* Literal.String.Other */
body .sr { color: #A45A77 } /* Literal.String.Regex */
body .s1 { color: #BA2121 } /* Literal.String.Single */
body .ss { color: #19177C } /* Literal.String.Symbol */
body .bp { color: #008000 } /* Name.Builtin.Pseudo */
body .fm { color: #0000FF } /* Name.Function.Magic */
body .vc { color: #19177C } /* Name.Variable.Class */
body .vg { color: #19177C } /* Name.Variable.Global */
body .vi { color: #19177C } /* Name.Variable.Instance */
body .vm { color: #19177C } /* Name.Variable.Magic */
body .il { color: #666666 } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;NebulaGraph graph store index.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">string</span> <span class="kn">import</span> <span class="n">Template</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="nn">tenacity</span> <span class="kn">import</span> <span class="n">retry</span><span class="p">,</span> <span class="n">stop_after_attempt</span><span class="p">,</span> <span class="n">wait_random_exponential</span>

<span class="kn">from</span> <span class="nn">llama_index.graph_stores.types</span> <span class="kn">import</span> <span class="n">GraphStore</span>

<span class="n">QUOTE</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span>
<span class="n">RETRY_TIMES</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">WAIT_MIN_SECONDS</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">WAIT_MAX_SECONDS</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="n">rel_query_sample_edge</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">MATCH ()-[e:`$edge_type`]-&gt;()</span>
<span class="sd">RETURN [src(e), dst(e)] AS sample_edge LIMIT 1</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="p">)</span>

<span class="n">rel_query_edge_type</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">MATCH (m)-[:`$edge_type`]-&gt;(n)</span>
<span class="sd">  WHERE id(m) == &quot;$src_id&quot; AND id(n) == &quot;$dst_id&quot;</span>
<span class="sd">RETURN &quot;(:&quot; + tags(m)[0] + &quot;)-[:$edge_type]-&gt;(:&quot; + tags(n)[0] + &quot;)&quot; AS rels</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">hash_string_to_rank</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="c1"># get signed 64-bit hash value</span>
    <span class="n">signed_hash</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>

    <span class="c1"># reduce the hash value to a 64-bit range</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">64</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">signed_hash</span> <span class="o">&amp;=</span> <span class="n">mask</span>

    <span class="c1"># convert the signed hash value to an unsigned 64-bit integer</span>
    <span class="k">if</span> <span class="n">signed_hash</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">63</span><span class="p">):</span>
        <span class="n">unsigned_hash</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="n">signed_hash</span> <span class="o">^</span> <span class="n">mask</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">unsigned_hash</span> <span class="o">=</span> <span class="n">signed_hash</span>

    <span class="k">return</span> <span class="n">unsigned_hash</span>


<span class="k">def</span> <span class="nf">prepare_subjs_param</span><span class="p">(</span><span class="n">subjs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepare parameters for query.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">subjs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="kn">from</span> <span class="nn">nebula3.common</span> <span class="kn">import</span> <span class="n">ttypes</span>

    <span class="n">subjs_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">subjs_byte</span> <span class="o">=</span> <span class="n">ttypes</span><span class="o">.</span><span class="n">Value</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="n">subjs</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subj</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subject should be str, but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">subj</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">subj_byte</span> <span class="o">=</span> <span class="n">ttypes</span><span class="o">.</span><span class="n">Value</span><span class="p">()</span>
        <span class="n">subj_byte</span><span class="o">.</span><span class="n">set_sVal</span><span class="p">(</span><span class="n">subj</span><span class="p">)</span>
        <span class="n">subjs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subj_byte</span><span class="p">)</span>
    <span class="n">subjs_nlist</span> <span class="o">=</span> <span class="n">ttypes</span><span class="o">.</span><span class="n">NList</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">subjs_list</span><span class="p">)</span>
    <span class="n">subjs_byte</span><span class="o">.</span><span class="n">set_lVal</span><span class="p">(</span><span class="n">subjs_nlist</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;subjs&quot;</span><span class="p">:</span> <span class="n">subjs_byte</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">escape_str</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Escape String for NebulaGraph Query.&quot;&quot;&quot;</span>
    <span class="n">patterns</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;&quot;&#39;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">patterns</span><span class="p">[</span><span class="n">pattern</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span> <span class="ow">or</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">NebulaGraphStore</span><span class="p">(</span><span class="n">GraphStore</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;NebulaGraph graph store.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">session_pool</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">space_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">edge_types</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;relationship&quot;</span><span class="p">],</span>
        <span class="n">rel_prop_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;relationship&quot;</span><span class="p">],</span>
        <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;entity&quot;</span><span class="p">],</span>
        <span class="n">session_pool_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize NebulaGraph graph store.</span>

<span class="sd">        Args:</span>
<span class="sd">            session_pool: NebulaGraph session pool.</span>
<span class="sd">            space_name: NebulaGraph space name.</span>
<span class="sd">            edge_types: Edge types.</span>
<span class="sd">            rel_prop_names: Relation property names corresponding to edge types.</span>
<span class="sd">            session_pool_kwargs: Keyword arguments for NebulaGraph session pool.</span>
<span class="sd">            **kwargs: Keyword arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">nebula3</span>  <span class="c1"># noqa</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;Please install NebulaGraph Python client first: &quot;</span>
                <span class="s2">&quot;`pip install nebula3-python`&quot;</span>
            <span class="p">)</span>
        <span class="k">assert</span> <span class="n">space_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;space_name should be provided.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_space_name</span> <span class="o">=</span> <span class="n">space_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_session_pool_kwargs</span> <span class="o">=</span> <span class="n">session_pool_kwargs</span>

        <span class="k">if</span> <span class="n">session_pool</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_session_pool</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="o">=</span> <span class="n">tags</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;entity&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_edge_types</span> <span class="o">=</span> <span class="n">edge_types</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;rel&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rel_prop_names</span> <span class="o">=</span> <span class="n">rel_prop_names</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;predicate&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_edge_types</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rel_prop_names</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;edge_types and rel_prop_names to define relation and relation name&quot;</span>
                <span class="s2">&quot;should be provided.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_edge_types</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Length of `edge_types` should be greater than 0.&quot;</span><span class="p">)</span>

        <span class="c1"># for building query</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_edge_dot_rel</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="n">edge_type</span><span class="si">}</span><span class="s2">`.`</span><span class="si">{</span><span class="n">rel_prop_name</span><span class="si">}</span><span class="s2">`&quot;</span>
            <span class="k">for</span> <span class="n">edge_type</span><span class="p">,</span> <span class="n">rel_prop_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_edge_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rel_prop_names</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">init_session_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return NebulaGraph session pool.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">nebula3.Config</span> <span class="kn">import</span> <span class="n">SessionPoolConfig</span>
        <span class="kn">from</span> <span class="nn">nebula3.gclient.net.SessionPool</span> <span class="kn">import</span> <span class="n">SessionPool</span>

        <span class="c1"># ensure &quot;NEBULA_USER&quot;, &quot;NEBULA_PASSWORD&quot;, &quot;NEBULA_ADDRESS&quot; are set</span>
        <span class="c1"># in environment variables</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
            <span class="n">key</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;NEBULA_USER&quot;</span><span class="p">,</span> <span class="s2">&quot;NEBULA_PASSWORD&quot;</span><span class="p">,</span> <span class="s2">&quot;NEBULA_ADDRESS&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;NEBULA_USER, NEBULA_PASSWORD, NEBULA_ADDRESS should be set in &quot;</span>
                <span class="s2">&quot;environment variables when NebulaGraph Session Pool is not &quot;</span>
                <span class="s2">&quot;directly passed.&quot;</span>
            <span class="p">)</span>
        <span class="n">graphd_host</span><span class="p">,</span> <span class="n">graphd_port</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;NEBULA_ADDRESS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="n">session_pool</span> <span class="o">=</span> <span class="n">SessionPool</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;NEBULA_USER&quot;</span><span class="p">],</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;NEBULA_PASSWORD&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_space_name</span><span class="p">,</span>
            <span class="p">[(</span><span class="n">graphd_host</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">graphd_port</span><span class="p">))],</span>
        <span class="p">)</span>

        <span class="n">seesion_pool_config</span> <span class="o">=</span> <span class="n">SessionPoolConfig</span><span class="p">()</span>
        <span class="n">session_pool</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">seesion_pool_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_session_pool</span> <span class="o">=</span> <span class="n">session_pool</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session_pool</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close NebulaGraph session pool.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_session_pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nd">@retry</span><span class="p">(</span>
        <span class="n">wait</span><span class="o">=</span><span class="n">wait_random_exponential</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="n">WAIT_MIN_SECONDS</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">WAIT_MAX_SECONDS</span><span class="p">),</span>
        <span class="n">stop</span><span class="o">=</span><span class="n">stop_after_attempt</span><span class="p">(</span><span class="n">RETRY_TIMES</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">param_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{})</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute query.</span>

<span class="sd">        Args:</span>
<span class="sd">            query: Query.</span>
<span class="sd">            param_map: Parameter map.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Query result.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">nebula3.Exception</span> <span class="kn">import</span> <span class="n">IOErrorException</span>
        <span class="kn">from</span> <span class="nn">nebula3.fbthrift.transport.TTransport</span> <span class="kn">import</span> <span class="n">TTransportException</span>

        <span class="c1"># Clean the query string by removing triple backticks</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session_pool</span><span class="o">.</span><span class="n">execute_parameter</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">param_map</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Query failed. Query: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">, Param: </span><span class="si">{</span><span class="n">param_map</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">is_succeeded</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Query failed. Query: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">, Param: </span><span class="si">{</span><span class="n">param_map</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Error message: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">error_msg</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">TTransportException</span><span class="p">,</span> <span class="n">IOErrorException</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Connection issue, try to recreate session pool. Query: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Param: </span><span class="si">{</span><span class="n">param_map</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Erorr: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_session_pool</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Session pool recreated. Query: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">, Param: </span><span class="si">{</span><span class="n">param_map</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;This was due to error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">, and now retrying.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># query failed on db side</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Query failed. Query: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">, Param: </span><span class="si">{</span><span class="n">param_map</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Error message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># other exceptions</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Query failed. Query: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">, Param: </span><span class="si">{</span><span class="n">param_map</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Error message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;GraphStore&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize graph store from configuration dictionary.</span>

<span class="sd">        Args:</span>
<span class="sd">            config_dict: Configuration dictionary.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Graph store.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">config_dict</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">client</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return NebulaGraph session pool.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session_pool</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">config_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return configuration dictionary.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;session_pool&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session_pool</span><span class="p">,</span>
            <span class="s2">&quot;space_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_space_name</span><span class="p">,</span>
            <span class="s2">&quot;edge_types&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edge_types</span><span class="p">,</span>
            <span class="s2">&quot;rel_prop_names&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rel_prop_names</span><span class="p">,</span>
            <span class="s2">&quot;session_pool_kwargs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session_pool_kwargs</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subj</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get triplets.</span>

<span class="sd">        Args:</span>
<span class="sd">            subj: Subject.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Triplets.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_edge_types</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># edge_types = [&quot;follow&quot;]</span>
            <span class="c1"># rel_prop_names = [&quot;degree&quot;]</span>
            <span class="c1"># GO FROM &quot;player100&quot; OVER `follow``</span>
            <span class="c1"># YIELD `follow`.`degree`` AS rel, dst(edge) AS obj</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;GO FROM </span><span class="si">{</span><span class="n">QUOTE</span><span class="si">}{</span><span class="n">subj</span><span class="si">}{</span><span class="n">QUOTE</span><span class="si">}</span><span class="s2"> OVER `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_edge_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">`&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;YIELD `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_edge_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">`.`</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_rel_prop_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">` AS rel, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;dst(edge) AS obj&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># edge_types = [&quot;follow&quot;, &quot;serve&quot;]</span>
            <span class="c1"># rel_prop_names = [&quot;degree&quot;, &quot;start_year&quot;]</span>
            <span class="c1"># GO FROM &quot;player100&quot; OVER `follow`, `serve`</span>
            <span class="c1"># YIELD [value IN [follow.degree,serve.start_year]</span>
            <span class="c1"># WHERE value IS NOT EMPTY ][0] AS rel, dst(edge) AS obj</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;GO FROM </span><span class="si">{</span><span class="n">QUOTE</span><span class="si">}{</span><span class="n">subj</span><span class="si">}{</span><span class="n">QUOTE</span><span class="si">}</span><span class="s2"> OVER &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="s1">&#39;`, `&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_edge_types</span><span class="p">)</span><span class="si">}</span><span class="s2">` &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;YIELD &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;[value IN [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_edge_dot_rel</span><span class="p">)</span><span class="si">}</span><span class="s2">] &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;WHERE value IS NOT EMPTY][0] AS rel, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;dst(edge) AS obj&quot;</span>
            <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Query: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="c1"># get raw data</span>
        <span class="n">rels</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">column_values</span><span class="p">(</span><span class="s2">&quot;rel&quot;</span><span class="p">)</span>
        <span class="n">objs</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">column_values</span><span class="p">(</span><span class="s2">&quot;obj&quot;</span><span class="p">)</span>

        <span class="c1"># convert to list of list</span>
        <span class="k">return</span> <span class="p">[[</span><span class="nb">str</span><span class="p">(</span><span class="n">rel</span><span class="o">.</span><span class="n">cast</span><span class="p">()),</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">cast</span><span class="p">())]</span> <span class="k">for</span> <span class="n">rel</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rels</span><span class="p">,</span> <span class="n">objs</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">get_flat_rel_map</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">subjs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get flat rel map.&quot;&quot;&quot;</span>
        <span class="c1"># The flat means for multi-hop relation path, we could get</span>
        <span class="c1"># knowledge like: subj -rel-&gt; obj -rel-&gt; obj &lt;-rel- obj.</span>
        <span class="c1"># This type of knowledge is useful for some tasks.</span>
        <span class="c1"># +-------------+------------------------------------+</span>
        <span class="c1"># | subj        | flattened_rels                     |</span>
        <span class="c1"># +-------------+------------------------------------+</span>
        <span class="c1"># | &quot;player101&quot; | [95, &quot;player125&quot;, 2002, &quot;team204&quot;] |</span>
        <span class="c1"># | &quot;player100&quot; | [1997, &quot;team204&quot;]                  |</span>
        <span class="c1"># ...</span>
        <span class="c1"># +-------------+------------------------------------+</span>
        <span class="n">rel_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">subjs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">subjs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># unlike simple graph_store, we don&#39;t do get_all here</span>
            <span class="k">return</span> <span class="n">rel_map</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_edge_types</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># WITH map{`true`: &quot;-[&quot;, `false`: &quot;&lt;-[&quot;} AS arrow_l,</span>
            <span class="c1">#      map{`true`: &quot;]-&gt;&quot;, `false`: &quot;]-&quot;} AS arrow_r</span>
            <span class="c1"># MATCH (s)-[e:follow*..2]-() WHERE id(s) IN [&quot;player100&quot;, &quot;player101&quot;]</span>
            <span class="c1">#   WITH id(s) AS subj, [rel in e | [</span>
            <span class="c1">#      arrow_l[tostring(typeid(rel) &gt; 0)] +</span>
            <span class="c1">#         tostring(rel.degree)+</span>
            <span class="c1">#      arrow_r[tostring(typeid(rel) &gt; 0)],</span>
            <span class="c1">#      CASE typeid(rel) &gt; 0</span>
            <span class="c1">#         WHEN true THEN dst(rel)</span>
            <span class="c1">#         WHEN false THEN src(rel)</span>
            <span class="c1">#      END</span>
            <span class="c1">#      ]</span>
            <span class="c1">#   ] AS rels</span>
            <span class="c1">#   WITH</span>
            <span class="c1">#       subj,</span>
            <span class="c1">#       REDUCE(acc = collect(NULL), l in rels | acc + l) AS flattened_rels</span>
            <span class="c1"># RETURN</span>
            <span class="c1">#   subj,</span>
            <span class="c1">#   REDUCE(acc = subj,l in flattened_rels|acc + &#39;, &#39; + l) AS flattened_rels</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;WITH map</span><span class="se">{{</span><span class="s2">`true`: &#39;-[&#39;, `false`: &#39;&lt;-[&#39;</span><span class="se">}}</span><span class="s2"> AS arrow_l,&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;     map</span><span class="se">{{</span><span class="s2">`true`: &#39;]-&gt;&#39;, `false`: &#39;]-&#39;</span><span class="se">}}</span><span class="s2"> AS arrow_r &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;MATCH (s)-[e:`</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_edge_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">`*..</span><span class="si">{</span><span class="n">depth</span><span class="si">}</span><span class="s2">]-() &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  WHERE id(s) IN $subjs &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;WITH &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;id(s) AS subj,&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;[rel IN e | &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  [&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  arrow_l[tostring(typeid(rel) &gt; 0)] +&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;      rel.`</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_rel_prop_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">`+&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  arrow_r[tostring(typeid(rel) &gt; 0)],&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  CASE typeid(rel) &gt; 0&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;    WHEN true THEN dst(rel)&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;    WHEN false THEN src(rel)&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  END&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  ]&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;] AS rels &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;WITH &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  subj,&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  REDUCE(acc = collect(NULL), l in rels | acc + l)&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;    AS flattened_rels&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; RETURN&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  subj,&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  REDUCE(acc = subj, l in flattened_rels | acc + &#39;, &#39; + l )&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;    AS flattened_rels&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># edge_types = [&quot;follow&quot;, &quot;serve&quot;]</span>
            <span class="c1"># rel_prop_names = [&quot;degree&quot;, &quot;start_year&quot;]</span>
            <span class="c1"># WITH map{`true`: &quot;-[&quot;, `false`: &quot;&lt;-[&quot;} AS arrow_l,</span>
            <span class="c1">#      map{`true`: &quot;]-&gt;&quot;, `false`: &quot;]-&quot;} AS arrow_r</span>
            <span class="c1"># MATCH (s)-[e:follow|serve*..2]-()</span>
            <span class="c1"># WHERE id(s) IN [&quot;player100&quot;, &quot;player101&quot;]</span>
            <span class="c1">#   WITH id(s) AS subj,</span>
            <span class="c1">#        [rel in e | [CASE type(rel)</span>
            <span class="c1">#     WHEN &quot;follow&quot; THEN</span>
            <span class="c1">#      arrow_l[tostring(typeid(rel) &gt; 0)] +</span>
            <span class="c1">#         tostring(rel.degree)+</span>
            <span class="c1">#      arrow_r[tostring(typeid(rel) &gt; 0)]</span>
            <span class="c1">#     WHEN &quot;serve&quot; THEN</span>
            <span class="c1">#      arrow_l[tostring(typeid(rel) &gt; 0)] +</span>
            <span class="c1">#         tostring(rel.start_year)+</span>
            <span class="c1">#      arrow_r[tostring(typeid(rel) &gt; 0)]</span>
            <span class="c1">#     END,</span>
            <span class="c1">#     CASE typeid(rel) &gt; 0</span>
            <span class="c1">#       WHEN true THEN dst(rel)</span>
            <span class="c1">#       WHEN false THEN src(rel)</span>
            <span class="c1">#     END</span>
            <span class="c1">#     ]</span>
            <span class="c1"># ] AS rels</span>
            <span class="c1">#   WITH</span>
            <span class="c1">#     subj,</span>
            <span class="c1">#     REDUCE(acc = collect(NULL), l in rels | acc + l) AS</span>
            <span class="c1">#       flattened_rels</span>
            <span class="c1"># RETURN</span>
            <span class="c1">#   subj,</span>
            <span class="c1">#   REDUCE(acc = subj, l in flattened_rels | acc + &#39;, &#39; + l ) AS</span>
            <span class="c1">#       flattened_rels</span>
            <span class="n">_case_when_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;WHEN </span><span class="si">{</span><span class="n">QUOTE</span><span class="si">}{</span><span class="n">edge_type</span><span class="si">}{</span><span class="n">QUOTE</span><span class="si">}</span><span class="s2"> THEN &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;  arrow_l[tostring(typeid(rel) &gt; 0)] +&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;  rel.`</span><span class="si">{</span><span class="n">rel_prop_name</span><span class="si">}</span><span class="s2">` +&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;  arrow_r[tostring(typeid(rel) &gt; 0)] &quot;</span>
                    <span class="k">for</span> <span class="n">edge_type</span><span class="p">,</span> <span class="n">rel_prop_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_edge_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rel_prop_names</span>
                    <span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;WITH map</span><span class="se">{{</span><span class="s2">`true`: &#39;-[&#39;, `false`: &#39;&lt;-[&#39;</span><span class="se">}}</span><span class="s2"> AS arrow_l,&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;     map</span><span class="se">{{</span><span class="s2">`true`: &#39;]-&gt;&#39;, `false`: &#39;]-&#39;</span><span class="se">}}</span><span class="s2"> AS arrow_r &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;MATCH (s)-[e:`</span><span class="si">{</span><span class="s1">&#39;`|`&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_edge_types</span><span class="p">)</span><span class="si">}</span><span class="s2">`*..</span><span class="si">{</span><span class="n">depth</span><span class="si">}</span><span class="s2">]-() &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  WHERE id(s) IN $subjs &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  WITH &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;    id(s) AS subj,&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; [rel IN e | &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  [CASE type(rel) &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">_case_when_string</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  END, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  CASE typeid(rel) &gt; 0&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;    WHEN true THEN dst(rel)&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;    WHEN false THEN src(rel)&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  END&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  ] &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;] AS rels &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  WITH&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;    subj,&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;    REDUCE(acc = collect(NULL), l in rels | acc + l) AS &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;        flattened_rels&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;RETURN&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  subj,&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  REDUCE(acc = subj, l in flattened_rels | acc + &#39;, &#39; + l ) AS &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;      flattened_rels&quot;</span>
            <span class="p">)</span>
        <span class="n">subjs_param</span> <span class="o">=</span> <span class="n">prepare_subjs_param</span><span class="p">(</span><span class="n">subjs</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;get_flat_rel_map() subjs_param: </span><span class="si">{</span><span class="n">subjs</span><span class="si">}</span><span class="s2">, query: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">subjs_param</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rel_map</span>

        <span class="c1"># get raw data</span>
        <span class="n">subjs_</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">column_values</span><span class="p">(</span><span class="s2">&quot;subj&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">rels_</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">column_values</span><span class="p">(</span><span class="s2">&quot;flattened_rels&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">subj</span><span class="p">,</span> <span class="n">rel</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">subjs_</span><span class="p">,</span> <span class="n">rels_</span><span class="p">):</span>
            <span class="n">subj_</span> <span class="o">=</span> <span class="n">subj</span><span class="o">.</span><span class="n">cast</span><span class="p">()</span>
            <span class="n">rel_</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">cast</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">subj_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rel_map</span><span class="p">:</span>
                <span class="n">rel_map</span><span class="p">[</span><span class="n">subj_</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rel_map</span><span class="p">[</span><span class="n">subj_</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rel_</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rel_map</span>

    <span class="k">def</span> <span class="nf">get_rel_map</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">subjs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get rel map.&quot;&quot;&quot;</span>
        <span class="c1"># We put rels in a long list for depth&gt;= 1, this is different from</span>
        <span class="c1"># SimpleGraphStore.get_rel_map() though.</span>
        <span class="c1"># But this makes more sense for multi-hop relation path.</span>

        <span class="k">if</span> <span class="n">subjs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subjs</span> <span class="o">=</span> <span class="p">[</span><span class="n">escape_str</span><span class="p">(</span><span class="n">subj</span><span class="p">)</span> <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="n">subjs</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subjs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{}</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_flat_rel_map</span><span class="p">(</span><span class="n">subjs</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">upsert_triplet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subj</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rel</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add triplet.&quot;&quot;&quot;</span>
        <span class="c1"># Note, to enable leveraging existing knowledge graph,</span>
        <span class="c1"># the (triplet -- property graph) mapping</span>
        <span class="c1">#   makes (n:1) edge_type.prop_name --&gt; triplet.rel</span>
        <span class="c1"># thus we have to assume rel to be the first edge_type.prop_name</span>
        <span class="c1"># here in upsert_triplet().</span>
        <span class="c1"># This applies to the type of entity(tags) with subject and object, too,</span>
        <span class="c1"># thus we have to assume subj to be the first entity.tag_name</span>

        <span class="c1"># lower case subj, rel, obj</span>
        <span class="n">subj</span> <span class="o">=</span> <span class="n">escape_str</span><span class="p">(</span><span class="n">subj</span><span class="p">)</span>
        <span class="n">rel</span> <span class="o">=</span> <span class="n">escape_str</span><span class="p">(</span><span class="n">rel</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">escape_str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="n">edge_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edge_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rel_prop_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rel_prop_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">entity_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rel_hash</span> <span class="o">=</span> <span class="n">hash_string_to_rank</span><span class="p">(</span><span class="n">rel</span><span class="p">)</span>
        <span class="n">dml_query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;INSERT VERTEX `</span><span class="si">{</span><span class="n">entity_type</span><span class="si">}</span><span class="s2">`(name) &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  VALUES </span><span class="si">{</span><span class="n">QUOTE</span><span class="si">}{</span><span class="n">subj</span><span class="si">}{</span><span class="n">QUOTE</span><span class="si">}</span><span class="s2">:(</span><span class="si">{</span><span class="n">QUOTE</span><span class="si">}{</span><span class="n">subj</span><span class="si">}{</span><span class="n">QUOTE</span><span class="si">}</span><span class="s2">);&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;INSERT VERTEX `</span><span class="si">{</span><span class="n">entity_type</span><span class="si">}</span><span class="s2">`(name) &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  VALUES </span><span class="si">{</span><span class="n">QUOTE</span><span class="si">}{</span><span class="n">obj</span><span class="si">}{</span><span class="n">QUOTE</span><span class="si">}</span><span class="s2">:(</span><span class="si">{</span><span class="n">QUOTE</span><span class="si">}{</span><span class="n">obj</span><span class="si">}{</span><span class="n">QUOTE</span><span class="si">}</span><span class="s2">);&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;INSERT EDGE `</span><span class="si">{</span><span class="n">edge_type</span><span class="si">}</span><span class="s2">`(`</span><span class="si">{</span><span class="n">rel_prop_name</span><span class="si">}</span><span class="s2">`) &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  VALUES &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">QUOTE</span><span class="si">}{</span><span class="n">subj</span><span class="si">}{</span><span class="n">QUOTE</span><span class="si">}</span><span class="s2">-&gt;</span><span class="si">{</span><span class="n">QUOTE</span><span class="si">}{</span><span class="n">obj</span><span class="si">}{</span><span class="n">QUOTE</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;@</span><span class="si">{</span><span class="n">rel_hash</span><span class="si">}</span><span class="s2">:(</span><span class="si">{</span><span class="n">QUOTE</span><span class="si">}{</span><span class="n">rel</span><span class="si">}{</span><span class="n">QUOTE</span><span class="si">}</span><span class="s2">);&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;upsert_triplet() DML query: </span><span class="si">{</span><span class="n">dml_query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">dml_query</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">result</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">is_succeeded</span><span class="p">()</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Failed to upsert triplet: </span><span class="si">{</span><span class="n">subj</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">rel</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2">, query: </span><span class="si">{</span><span class="n">dml_query</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subj</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rel</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete triplet.</span>
<span class="sd">        1. Similar to upsert_triplet(),</span>
<span class="sd">           we have to assume rel to be the first edge_type.prop_name.</span>
<span class="sd">        2. After edge being deleted, we need to check if the subj or</span>
<span class="sd">           obj are isolated vertices,</span>
<span class="sd">           if so, delete them, too.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># lower case subj, rel, obj</span>
        <span class="n">subj</span> <span class="o">=</span> <span class="n">escape_str</span><span class="p">(</span><span class="n">subj</span><span class="p">)</span>
        <span class="n">rel</span> <span class="o">=</span> <span class="n">escape_str</span><span class="p">(</span><span class="n">rel</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">escape_str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="c1"># DELETE EDGE serve &quot;player100&quot; -&gt; &quot;team204&quot;@7696463696635583936;</span>
        <span class="n">edge_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edge_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># rel_prop_name = self._rel_prop_names[0]</span>
        <span class="n">rel_hash</span> <span class="o">=</span> <span class="n">hash_string_to_rank</span><span class="p">(</span><span class="n">rel</span><span class="p">)</span>
        <span class="n">dml_query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;DELETE EDGE `</span><span class="si">{</span><span class="n">edge_type</span><span class="si">}</span><span class="s2">`&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">QUOTE</span><span class="si">}{</span><span class="n">subj</span><span class="si">}{</span><span class="n">QUOTE</span><span class="si">}</span><span class="s2">-&gt;</span><span class="si">{</span><span class="n">QUOTE</span><span class="si">}{</span><span class="n">obj</span><span class="si">}{</span><span class="n">QUOTE</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">rel_hash</span><span class="si">}</span><span class="s2">;&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;delete() DML query: </span><span class="si">{</span><span class="n">dml_query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">dml_query</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">result</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">is_succeeded</span><span class="p">()</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Failed to delete triplet: </span><span class="si">{</span><span class="n">subj</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">rel</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2">, query: </span><span class="si">{</span><span class="n">dml_query</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="c1"># Get isolated vertices to be deleted</span>
        <span class="c1"># MATCH (s) WHERE id(s) IN [&quot;player700&quot;] AND NOT (s)-[]-()</span>
        <span class="c1"># RETURN id(s) AS isolated</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;MATCH (s) &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  WHERE id(s) IN [</span><span class="si">{</span><span class="n">QUOTE</span><span class="si">}{</span><span class="n">subj</span><span class="si">}{</span><span class="n">QUOTE</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">QUOTE</span><span class="si">}{</span><span class="n">obj</span><span class="si">}{</span><span class="n">QUOTE</span><span class="si">}</span><span class="s2">] &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  AND NOT (s)-[]-() &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;RETURN id(s) AS isolated&quot;</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">isolated</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">column_values</span><span class="p">(</span><span class="s2">&quot;isolated&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isolated</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># DELETE VERTEX &quot;player700&quot;</span>
        <span class="n">vertex_ids</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">QUOTE</span><span class="si">}{</span><span class="n">v</span><span class="o">.</span><span class="n">cast</span><span class="p">()</span><span class="si">}{</span><span class="n">QUOTE</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">isolated</span><span class="p">])</span>
        <span class="n">dml_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;DELETE VERTEX </span><span class="si">{</span><span class="n">vertex_ids</span><span class="si">}</span><span class="s2">;&quot;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">dml_query</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">result</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">is_succeeded</span><span class="p">()</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Failed to delete isolated vertices: </span><span class="si">{</span><span class="n">isolated</span><span class="si">}</span><span class="s2">, query: </span><span class="si">{</span><span class="n">dml_query</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="nf">refresh_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Refreshes the NebulaGraph Store Schema.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tags_schema</span><span class="p">,</span> <span class="n">edge_types_schema</span><span class="p">,</span> <span class="n">relationships</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SHOW TAGS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">column_values</span><span class="p">(</span><span class="s2">&quot;Name&quot;</span><span class="p">):</span>
            <span class="n">tag_name</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">cast</span><span class="p">()</span>
            <span class="n">tag_schema</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tag&quot;</span><span class="p">:</span> <span class="n">tag_name</span><span class="p">,</span> <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DESCRIBE TAG `</span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">)</span>
            <span class="n">props</span><span class="p">,</span> <span class="n">types</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">column_values</span><span class="p">(</span><span class="s2">&quot;Field&quot;</span><span class="p">),</span> <span class="n">r</span><span class="o">.</span><span class="n">column_values</span><span class="p">(</span><span class="s2">&quot;Type&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">row_size</span><span class="p">()):</span>
                <span class="n">tag_schema</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">props</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cast</span><span class="p">(),</span> <span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cast</span><span class="p">()))</span>
            <span class="n">tags_schema</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag_schema</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">edge_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SHOW EDGES&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">column_values</span><span class="p">(</span><span class="s2">&quot;Name&quot;</span><span class="p">):</span>
            <span class="n">edge_type_name</span> <span class="o">=</span> <span class="n">edge_type</span><span class="o">.</span><span class="n">cast</span><span class="p">()</span>
            <span class="n">edge_schema</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;edge&quot;</span><span class="p">:</span> <span class="n">edge_type_name</span><span class="p">,</span> <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DESCRIBE EDGE `</span><span class="si">{</span><span class="n">edge_type_name</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">)</span>
            <span class="n">props</span><span class="p">,</span> <span class="n">types</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">column_values</span><span class="p">(</span><span class="s2">&quot;Field&quot;</span><span class="p">),</span> <span class="n">r</span><span class="o">.</span><span class="n">column_values</span><span class="p">(</span><span class="s2">&quot;Type&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">row_size</span><span class="p">()):</span>
                <span class="n">edge_schema</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">props</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cast</span><span class="p">(),</span> <span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cast</span><span class="p">()))</span>
            <span class="n">edge_types_schema</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge_schema</span><span class="p">)</span>

            <span class="c1"># build relationships types</span>
            <span class="n">sample_edge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">rel_query_sample_edge</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">edge_type</span><span class="o">=</span><span class="n">edge_type_name</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">column_values</span><span class="p">(</span><span class="s2">&quot;sample_edge&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_edge</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">src_id</span><span class="p">,</span> <span class="n">dst_id</span> <span class="o">=</span> <span class="n">sample_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cast</span><span class="p">()</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">rel_query_edge_type</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span>
                    <span class="n">edge_type</span><span class="o">=</span><span class="n">edge_type_name</span><span class="p">,</span> <span class="n">src_id</span><span class="o">=</span><span class="n">src_id</span><span class="p">,</span> <span class="n">dst_id</span><span class="o">=</span><span class="n">dst_id</span>
                <span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">column_values</span><span class="p">(</span><span class="s2">&quot;rels&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">relationships</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cast</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Node properties: </span><span class="si">{</span><span class="n">tags_schema</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Edge properties: </span><span class="si">{</span><span class="n">edge_types_schema</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Relationships: </span><span class="si">{</span><span class="n">relationships</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the schema of the NebulaGraph store.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">refresh</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_schema</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;get_schema() schema:</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span>

    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">param_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{})</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">param_map</span><span class="p">)</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">d</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">col_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">col_size</span><span class="p">()):</span>
            <span class="n">col_name</span> <span class="o">=</span> <span class="n">columns</span><span class="p">[</span><span class="n">col_num</span><span class="p">]</span>
            <span class="n">col_list</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">column_values</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span>
            <span class="n">d</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">cast</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">col_list</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">d</span>
</pre></div>
</body>
</html>
